<div class="container-fluid" *ngIf="(approval)">

  <div class="row">
    <span class="col-md-2 badge rounded-pill bg-warning mb-3 fs-5">Approval Data</span>
    <h3 class="col-md-3 mx-auto text-capitalize fw-bold fst-italic text-decoration-underline"
      [ngClass]="this.onlineStatus[this.approval.onlineStatusId]">
      {{this.onlineStatus[this.approval.onlineStatusId]}}.
    </h3>
  </div>

  <!-- Approval Master -->
  <div class="row">

    <div class="col">

      <div class="row fw-bold fst-italic">

        <label *ngIf="isCMC()" for="planMaster" class="col-md-2 col-form-label">Masters Benefits</label>
        <div *ngIf="isCMC()" class="col-md-2">
          <select class="form-select form-select-sm mt-1" id="planMaster" name="planMaster" [(ngModel)]="masterBenefit"
            (ngModelChange)="onMasterBenefitChange()" required>
            <option [value]="masterBenefit" disabled hidden>Select</option>
            <option *ngFor="let master of (masterBenefits$ | async)" [ngValue]="master">
              {{master.masterBenefitName}}
            </option>
          </select>
        </div>

        <label *ngIf="isCMC()" for="planBenefit" class="col-md-2 col-form-label">Benefits</label>
        <div *ngIf="isCMC()" class="col-md-2">
          <select class="form-select form-select-sm mt-1" id="planBenefit" name="planBenefit" [(ngModel)]="benefit"
            (ngModelChange)="onBenefitChange()">
            <option [value]="benefit" disabled hidden>Select</option>
            <option *ngFor="let benefit of (benefits$ | async)" [ngValue]="benefit">
              {{benefit.benefitName}}
            </option>
          </select>
        </div>

        <label for="copayment" class="col-md-2 col-form-label">CoPayment Per</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="copayment" readonly
            value="{{approval.approvalCopaymentPer | percent}}">
        </div>

      </div>

      <div class="row fw-bold fst-italic">
        <label for="approvalNumber" class="col-md-2 col-form-label">Approval Number</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="approvalNumber" readonly
            value="{{approval.approvalNumber}}">
        </div>

        <label for="approvalDate" class="col-md-2 col-form-label">Approval Date</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="approvalDate" readonly
            value="{{approval.approvalDate | date}}">
        </div>

        <label for="claimNumber" class="col-md-2 col-form-label">Claim Number</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="claimNumber" readonly
            value="{{approval.claimNumber}}">
        </div>
      </div>

      <div class="row fw-bold fst-italic">
        <label for="name" class="col-md-2 col-form-label">Member Name</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="name" readonly
            value="{{approval.memberName}}">
        </div>

        <label for="cardNumber" class="col-md-2 col-form-label">Card Number</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="cardNumber" readonly
            value="{{approval.cardNumber}}">
        </div>

        <label for="ceiling" class="col-md-2 col-form-label">Available Ceiling</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="ceiling" readonly
            value="{{availableCeiling | number}}">
        </div>
      </div>

      <div class="row fw-bold fst-italic">
        <label for="plan" class="col-md-2 col-form-label">Member Plan</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="plan" readonly value="{{approval.planName}}">
        </div>

        <label for="customer" class="col-md-2 col-form-label">Customer Name</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="customer" readonly
            value="{{approval.customerName}}">
        </div>

        <label for="status" class="col-md-2 col-form-label">Member Status</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="status" readonly
            value="{{approval.memberStatus}}">
        </div>

      </div>

      <div class="row fw-bold fst-italic">
        <label for="provider" class="col-md-2 col-form-label">Provider Name</label>
        <div class="col-md-6">
          <input type="text" class="form-control form-control-sm mt-1" id="provider" readonly
            value="{{approval.providerName}}">
        </div>

        <label for="providerCat" class="col-md-2 col-form-label">Provider Cat</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="providerCat" readonly
            value="{{approval.providerCatName}}">
        </div>
      </div>

      <div class="row fw-bold fst-italic">
        <label for="diagnosis" class="col-md-2 col-form-label">Diagnosis</label>
        <div class="col-md-6">
          <input type="text" class="form-control form-control-sm mt-1" id="diagnosis" readonly
            value="{{approval.diagnosis}}">
        </div>

        <label for="ICDCode" class="col-md-2 col-form-label">ICDCode</label>
        <div class="col-md-2">
          <input type="text" class="form-control form-control-sm mt-1" id="ICDCode" readonly
            value="{{approval.icdCode}}">
        </div>
      </div>

      <div class="row fw-bold fst-italic">
        <label for="printedNote" class="col-md-2 col-form-label">Provider Notes</label>
        <div class="col-md-10">
          <textarea type="text" class="form-control form-control-sm mt-1" id="printedNote" readonly
            [value]="approval.printedNotes"></textarea>
        </div>
      </div>

      <div class="row mb-3 fw-bold fst-italic">
        <label for="internalNote" class="col-md-2 col-form-label">CMC Notes</label>
        <div class="col-md-10">
          <textarea type="text" class="form-control form-control-sm mt-1" id="internalNote" name="internalNotes"
            [(ngModel)]="approval.internalNotes" [readonly]="isProviderUser()"></textarea>
        </div>
      </div>

    </div>

    <!-- CMC Ceiling Summary -->
    <div *ngIf="isCMC()" class="col-md-3 mb-1 mt-1">
      <div>
        <table class="table table-sm table-bordered mb-1">
          <thead>
            <tr class="bg-warning text-white">
              <th>Ceiling</th>
              <th>Amount</th>
            </tr>
            <tr>
              <td>Annual</td>
              <td class="fw-bold text-success">{{ ceiling.annualCeiling | number }}</td>
            </tr>
            <tr>
              <td>Remaining Annual</td>
              <td class="fw-bold text-success">{{ ceiling.remainingAnnual | number }}</td>
            </tr>
            <tr>
              <td>Master Benefit</td>
              <td class="fw-bold text-success">{{ ceiling.masterCeiling | number }}</td>
            </tr>
            <tr>
              <td>Remainig Master</td>
              <td class="fw-bold text-success">{{ ceiling.remainingMaster | number }}</td>
            </tr>
            <tr>
              <td>Benefit</td>
              <td class="fw-bold text-success">{{ ceiling.benefitCeiling | number }}</td>
            </tr>
            <tr>
              <td>Remianig Benefit</td>
              <td class="fw-bold text-success">{{ ceiling.remainingBenefit | number }}</td>
            </tr>
          </thead>
        </table>
      </div>

      <div class="d-grid gap">
        <button type="button" class="btn btn-primary btn-sm fw-bold" data-bs-toggle="modal"
          data-bs-target="#approvalHistoryId" (click)="getMemberApprovals(approval.planMemberId)">Approvals
          History</button>
      </div>
    </div>

  </div>

  <!-- Approval Items -->
  <span class="badge rounded-pill bg-warning mb-3 fs-5">Approval Services</span>
  <div class="row">
    <table class="table table-bordered table-responsive table-sm">
      <thead class="fst-italic text-center">
        <tr>
          <th>Service Name</th>
          <th>Quantity</th>
          <th>Unit Amt</th>
          <th>Service Amt</th>
          <!-- <th>Copayment Per</th> -->
          <th>Copayment Amt</th>
          <th>Dosage</th>
          <th>Dosgae Per Day</th>
          <th>Dosgae Times</th>
          <th>Dosgae Days</th>
          <th *ngIf="isCMC()"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of approval.approvalItems" class="text-center"
          [class.text-decoration-line-through]="item.status === rejected">
          <td>{{item.serviceName}}</td>
          <td>{{item.serviceQnt}}</td>
          <td>{{item.serviceUnitAmt}}</td>
          <td>{{item.serviceTotalAmt}}</td>
          <!-- <td>{{item.serviceCopaymentPer}}</td> -->
          <td>{{item.serviceCopaymentAmt}}</td>
          <td>{{item.dosage}}</td>
          <td>{{item.dosagePerDay}}</td>
          <td>{{item.dosageTime}}</td>
          <td>{{item.dosageDays}}</td>

          <td *ngIf="isCMC()" class="text-center fst-italic">
            <button *ngIf="item.status === rejected" type="button" class="btn btn-outline-success btn-sm"
              (click)="toggleItem(item)">Accept</button>
            <button *ngIf="item.status !== rejected" type="button" class="btn btn-outline-danger btn-sm"
              (click)="toggleItem(item)">reject</button>
          </td>

        </tr>
      </tbody>
    </table>
  </div>

  <!-- Approval Price Summary -->
  <div class="row fw-bolder fst-italic text-center text-primary">

    <div class="col-md-6">
      <p class="mx-auto">Total Approval Amount: {{approval.approvalAmt}}</p>
    </div>
    <div class="col-md-6">
      <p class="mx-auto">Total Copayment Amount: {{approval.approvalCopaymentAmt}}</p>
    </div>

  </div>

  <!-- Accept & Reject Btns for CMC Doctor -->
  <div *ngIf="isCMC()" class="row mb-3">
    <div class="col-md-2 mx-auto">
      <button type="button" class="btn btn-success me-2" (click)="onSubmitApproval(onlineStatus.accepted)"
        [disabled]="(isValidApproval())">Accept</button>
      <button type="button" class="btn btn-danger" (click)="onSubmitApproval(onlineStatus.rejected)">Reject</button>
    </div>
  </div>

  <!-- Dispense Btn For Provider User -->
  <div class="row mb-3" *ngIf="showDispenseBtn()">
    <div class="col-md-2 mx-auto">
      <button type="button" class="btn btn-success" (click)="onDispense()">Dispense</button>
    </div>
  </div>

</div>

<!-- --------------------------------------------Bootstrap Modal----------------------------------------------------- -->
<div class="row">
  <div class="col">
    <div #modal class="modal fade" id="approvalHistoryId" tabindex="-1" data-bs-backdrop="static"
      data-bs-keyboard="false" aria-labelledby="bsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header text-warning table-info fst-italic fw-bolder">
            <h5 class="modal-title" id="bsModalLabel">Approval Services</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Approval Master Table -->
            <table class="table table-sm table-responsive table-bordered">
              <thead>
                <tr>
                  <th></th>
                  <th>MemberName</th>
                  <th>ApprovalNum</th>
                  <th>ApprovalDate</th>
                  <th>ApprovalAmt</th>
                  <th>ClaimNum</th>
                  <th>ProviderName</th>
                  <th>MasterBenefitName</th>
                  <th>BenfitName</th>
                  <th>Diagnosis</th>
                  <th>PrintedNotes</th>
                  <th>UserName</th>
                </tr>
              </thead>
              <tbody *ngFor="let app of (approvalsHistory$ | async)">
                <tr>
                  <td>
                    <div class="accordion" id="accordionExample">
                      <div class="accordion-item ">
                        <div class="accordion-header" id="headingOne">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                          </button>
                        </div>
                      </div>
                    </div>
                  </td>
                  <td>{{app.memberName}}</td>
                  <td>{{app.approvalNum}}</td>
                  <td>{{app.pprovalDate | date}}</td>
                  <td>{{app.approvalAmt | currency}}</td>
                  <td>{{app.claimNum}}</td>
                  <td>{{app.providerName}}</td>
                  <td>{{app.masterBenefitName}}</td>
                  <td>{{app.benfitName}}</td>
                  <td>{{app.diagnosis}}</td>
                  <td>{{app.printedNotes}}</td>
                  <td>{{app.userName}}</td>
                </tr>
                <tr>
                  <td colspan="12">
                    <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                      data-bs-parent="#accordionExample">
                      <div class="accordion-body">
                        <!-- Client Approval Items Table-->
                        <table class="table table-responsive table-sm mb-0 table-bordered">
                          <thead>
                            <tr>
                              <th>Service Name</th>
                              <th>Service Qnt</th>
                              <th>Service Unit Amt</th>
                              <th>Service Total Amt</th>
                              <th>Service Co-Payment Per</th>
                              <th>Service Co-Payment Amt</th>
                              <th>Service Net Amt</th>
                              <th>Dosage</th>
                              <th>Dosage Times</th>
                              <th>Dosage Per Day</th>
                              <th>Dosage Days</th>
                            </tr>
                          </thead>
                          <tbody *ngFor="let item of app.clientApprovalItems">
                            <tr>
                              <td>{{item.serviceName}}</td>
                              <td>{{item.serviceQnt}}</td>
                              <td>{{item.serviceUnitAmt}}</td>
                              <td>{{item.serviceTotalAmt}}</td>
                              <td>{{item.serviceCoPaymentPer}}</td>
                              <td>{{item.serviceCoPaymentAmt}}</td>
                              <td>{{item.serviceNetAmt}}</td>
                              <td>{{item.dosage}}</td>
                              <td>{{item.dosageDays}}</td>
                              <td>{{item.dosageTimes}}</td>
                              <td>{{item.dosagePerDay}}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
